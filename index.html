<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Seguimiento de Ventas de Competencia</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body {
            background-color: #f8f9fa;
            padding: 20px;
        }
        .container {
            max-width: 800px;
            background-color: white;
            padding: 2rem;
            border-radius: 10px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
            margin: 2rem auto;
        }
        h1 {
            color: #0d6efd;
            font-size: 2rem;
            margin-bottom: 1.5rem;
            text-align: center;
        }
        .competitor-row {
            background-color: #f8f9fa;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 10px;
        }
        .form-label {
            font-weight: 500;
        }
        .btn-primary {
            background-color: #0d6efd;
            border: none;
            padding: 10px 20px;
            font-weight: 500;
        }
        .btn-primary:hover {
            background-color: #0b5ed7;
        }
        .alert {
            display: none;
            margin-top: 20px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Seguimiento de Ventas de Competencia</h1>
        
        <form id="salesForm" class="needs-validation" novalidate>
            <div class="row mb-3">
                <div class="col-md-6">
                    <label for="promoterName" class="form-label">Nombre del Promotor</label>
                    <select class="form-select" id="promoterName" required>
                        <option value="" selected disabled>Seleccione un promotor</option>
                        <!-- Promoters will be added here dynamically -->
                    </select>
                    <div class="invalid-feedback">
                        Por favor seleccione un promotor
                    </div>
                </div>
                <div class="col-md-6">
                    <label for="storeName" class="form-label">Nombre de la Tienda</label>
                    <select class="form-select" id="storeName" required>
                        <option value="" selected disabled>Seleccione una tienda</option>
                        <!-- Stores will be added here dynamically -->
                    </select>
                    <div class="invalid-feedback">
                        Por favor seleccione una tienda
                    </div>
                </div>
            </div>

            <div class="row mb-3">
                <div class="col-md-6">
                    <label for="saleDate" class="form-label">Fecha</label>
                    <input type="date" class="form-control" id="saleDate" required>
                    <div class="invalid-feedback">
                        Por favor ingrese una fecha válida
                    </div>
                </div>
                <div class="col-md-6">
                    <label for="ourModel" class="form-label">Nuestro Modelo</label>
                    <select class="form-select" id="ourModel" required>
                        <option value="" selected disabled>Seleccione un modelo</option>
                        <!-- Models will be added here dynamically -->
                    </select>
                    <div class="invalid-feedback">
                        Por favor seleccione un modelo
                    </div>
                </div>
            </div>

            <div id="competitorModels" class="mt-4">
                <!-- Competitor models will be added here dynamically -->
            </div>

            <div class="d-grid gap-2 col-md-6 mx-auto mt-4">
                <button type="submit" class="btn btn-primary btn-lg">
                    <span class="spinner-border spinner-border-sm d-none" role="status" aria-hidden="true"></span>
                    Enviar Datos
                </button>
            </div>
        </form>

        <div id="successMessage" class="alert alert-success mt-3" role="alert" style="display: none;">
            ¡Datos enviados correctamente!
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Global variables
        const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbzOf03vWMJHyJVEn8Al41vJzUtSOYTcY2AfjfkJ0KvjbQz3BpQs0F_JJu0pjDbEM7SM/exec';
        const appData = {
            promoters: [],
            stores: [],
            modelCompetitors: {}
        };

        // Set today's date as default and initialize the app
        document.addEventListener('DOMContentLoaded', function() {
            // Set today's date as default (YYYY-MM-DD format)
            const today = new Date();
            const formattedDate = today.toISOString().split('T')[0];
            document.getElementById('saleDate').value = formattedDate;
            
            // Load initial data
            loadInitialData();
            
            // Add event listeners
            document.getElementById('ourModel').addEventListener('change', updateCompetitorFields);
            document.getElementById('promoterName').addEventListener('change', updateStoresForPromoter);
            document.getElementById('salesForm').addEventListener('submit', handleFormSubmit);
        });

        // Load initial data from Google Sheets
        function loadInitialData() {
            console.log('1. Starting to load initial data...');
            console.log('2. Script URL:', SCRIPT_URL);
            
            // Create a unique callback function name
            const callbackName = 'jsonp_callback_' + Math.round(100000 * Math.random());
            const url = `${SCRIPT_URL}?action=getData`;
            console.log('3. Generated URL:', url);
            
            // Set up the callback function
            window[callbackName] = function(result) {
                console.log('4. Callback received data:', result);
                
                // Check if we have valid data
                if (result && result.status === 'success' && result.data) {
                    console.log('5. Successfully received data');
                    
                    // Store the data
                    appData.promoters = result.data.promoters || [];
                    appData.stores = result.data.stores || [];
                    appData.modelCompetitors = result.data.modelCompetitors || {};
                    
                    console.log('6. Promoters loaded:', appData.promoters.length);
                    console.log('7. Stores loaded:', appData.stores.length);
                    console.log('8. Models loaded:', Object.keys(appData.modelCompetitors).length);
                    
                    // Initialize the UI
                    initializeDropdowns();
                } else {
                    console.error('9. Invalid data received:', result);
                    alert('Error: Datos inválidos recibidos del servidor');
                }
                
                // Clean up
                delete window[callbackName];
            };
            
            // Create script element for JSONP
            const script = document.createElement('script');
            script.src = `${url}&callback=${callbackName}`;
            console.log('10. Making JSONP request to:', script.src);
            
            // Set up error handling
            script.onerror = function() {
                console.error('11. Script load error');
                alert('Error al cargar los datos. Por favor, recarga la página.');
                delete window[callbackName];
            };
            
            // Set a timeout to clean up if the request takes too long
            const timeout = setTimeout(() => {
                if (window[callbackName]) {
                    console.error('12. Request timed out');
                    alert('La solicitud está tardando demasiado. Por favor, recarga la página.');
                    delete window[callbackName];
                    if (document.body.contains(script)) {
                        document.body.removeChild(script);
                    }
                }
            }, 30000); // 30 second timeout
            
            // Override the callback to clear the timeout
            const originalCallback = window[callbackName];
            window[callbackName] = function() {
                clearTimeout(timeout);
                originalCallback.apply(this, arguments);
            };
            
            // Add script to the page to make the request
            console.log('13. Appending script to body');
            document.body.appendChild(script);
            console.log('14. Script appended, request should be in progress');
        }

        // Function to update stores based on selected promoter
        function updateStoresForPromoter() {
            const promoterName = this.value;
            const storeSelect = document.getElementById('storeName');
            
            if (!promoterName) {
                // Reset stores if no promoter selected
                storeSelect.innerHTML = '<option value="" selected disabled>Seleccione una tienda</option>';
                appData.stores.forEach(store => {
                    const option = document.createElement('option');
                    option.value = store;
                    option.textContent = store;
                    storeSelect.appendChild(option);
                });
                return;
            }
            
            // Find the selected promoter
            const promoter = appData.promoters.find(p => p.name === promoterName);
            
            if (promoter && promoter.stores) {
                // Clear and populate with promoter's stores
                storeSelect.innerHTML = '<option value="" selected disabled>Seleccione una tienda</option>';
                promoter.stores.forEach(store => {
                    const option = document.createElement('option');
                    option.value = store;
                    option.textContent = store;
                    storeSelect.appendChild(option);
                });
            }
        }

        // Initialize dropdowns with data
        function initializeDropdowns() {
            console.log('15. Starting to initialize dropdowns');
            
            try {
                // Populate promoter dropdown
                const promoterSelect = document.getElementById('promoterName');
                if (!promoterSelect) {
                    console.error('16. Could not find promoter select element');
                    return;
                }
                
                console.log('17. Populating promoter dropdown with', appData.promoters.length, 'promoters');
                promoterSelect.innerHTML = '<option value="" selected disabled>Seleccione un promotor</option>';
                
                appData.promoters.forEach((promoter, index) => {
                    const option = document.createElement('option');
                    option.value = promoter.name;
                    option.textContent = promoter.name;
                    // Store stores as JSON string to handle multiple stores
                    option.setAttribute('data-stores', JSON.stringify(promoter.stores || []));
                    promoterSelect.appendChild(option);
                    console.log(`18. Added promoter ${index + 1}:`, promoter.name);
                });
                
                // Populate store dropdown with all stores initially
                const storeSelect = document.getElementById('storeName');
                if (!storeSelect) {
                    console.error('19. Could not find store select element');
                    return;
                }
                
                console.log('20. Populating store dropdown with', appData.stores.length, 'stores');
                storeSelect.innerHTML = '<option value="" selected disabled>Seleccione una tienda</option>';
                
                appData.stores.forEach((store, index) => {
                    const option = document.createElement('option');
                    option.value = store;
                    option.textContent = store;
                    storeSelect.appendChild(option);
                    console.log(`21. Added store ${index + 1}:`, store);
                });
                
                // Populate model dropdown
                const modelSelect = document.getElementById('ourModel');
                if (!modelSelect) {
                    console.error('22. Could not find model select element');
                    return;
                }
                
                const modelKeys = Object.keys(appData.modelCompetitors || {});
                console.log('23. Populating model dropdown with', modelKeys.length, 'models');
                modelSelect.innerHTML = '<option value="" selected disabled>Seleccione un modelo</option>';
                
                modelKeys.forEach((model, index) => {
                    const option = document.createElement('option');
                    option.value = model;
                    option.textContent = model;
                    modelSelect.appendChild(option);
                    console.log(`24. Added model ${index + 1}:`, model);
                });
                
                // Add event listener for promoter selection
                console.log('25. Adding event listener for promoter selection');
                promoterSelect.addEventListener('change', function() {
                    console.log('26. Promoter selection changed');
                    const selectedOption = this.options[this.selectedIndex];
                    const storesJson = selectedOption.getAttribute('data-stores');
                    
                    if (storesJson) {
                        try {
                            console.log('27. Processing stores for selected promoter');
                            const stores = JSON.parse(storesJson);
                            const storeSelect = document.getElementById('storeName');
                            
                            if (stores.length > 0) {
                                console.log('28. Found', stores.length, 'stores for selected promoter');
                                // Clear existing options
                                storeSelect.innerHTML = '';
                                
                                // Add new options
                                stores.forEach((store, index) => {
                                    const option = document.createElement('option');
                                    option.value = store;
                                    option.textContent = store;
                                    storeSelect.appendChild(option);
                                    console.log(`29. Added store option ${index + 1}:`, store);
                                });
                                
                                storeSelect.disabled = false;
                            } else {
                                console.log('30. No stores found for selected promoter');
                                storeSelect.innerHTML = '<option value="" selected disabled>No hay tiendas disponibles</option>';
                                storeSelect.disabled = true;
                            }
                        } catch (e) {
                            console.error('31. Error parsing stores:', e);
                        }
                    } else {
                        console.log('32. No stores data found for selected promoter');
                    }
                });
                
                console.log('33. Finished initializing dropdowns');
            } catch (error) {
                console.error('34. Error in initializeDropdowns:', error);
            }
        }

        // Update competitor fields based on selected model
        function updateCompetitorFields() {
            const selectedModel = this.value;
            const competitorModelsDiv = document.getElementById('competitorModels');
            competitorModelsDiv.innerHTML = ''; // Clear previous fields
            
            if (!selectedModel) return;
            
            const competitors = appData.modelCompetitors[selectedModel] || [];
            
            if (competitors.length === 0) {
                competitorModelsDiv.innerHTML = '<p>No se encontraron modelos competidores para el modelo seleccionado.</p>';
                return;
            }
            
            competitors.forEach((competitor, index) => {
                const competitorDiv = document.createElement('div');
                competitorDiv.className = 'competitor-row mb-3';
                competitorDiv.innerHTML = `
                    <h5>${competitor}</h5>
                    <div class="row">
                        <div class="col-md-6 mb-2">
                            <label for="sales-${index}" class="form-label">Ventas del Día</label>
                            <input type="number" class="form-control sales-input" id="sales-${index}" min="0" placeholder="Opcional">
                        </div>
                        <div class="col-md-6 mb-2">
                            <label for="stock-${index}" class="form-label">Stock Actual</label>
                            <input type="number" class="form-control stock-input" id="stock-${index}" min="0" placeholder="Opcional">
                        </div>
                    </div>
                `;
                competitorModelsDiv.appendChild(competitorDiv);
            });
        }

        // Handle form submission
        function handleFormSubmit(e) {
            e.preventDefault();
            
            const form = e.target;
            
            // Check form validity
            if (!form.checkValidity()) {
                e.stopPropagation();
                form.classList.add('was-validated');
                return;
            }
            
            const submitButton = form.querySelector('button[type="submit"]');
            const originalButtonText = submitButton.innerHTML;
            
            // Show loading state
            submitButton.disabled = true;
            submitButton.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Enviando...';
            
            // Prepare form data
            const formData = {
                promoterName: document.getElementById('promoterName').value,
                storeName: document.getElementById('storeName').value,
                saleDate: document.getElementById('saleDate').value,
                ourModel: document.getElementById('ourModel').value,
                competitors: []
            };
            
            // Get competitor data
            const competitorRows = document.querySelectorAll('.competitor-row');
            competitorRows.forEach((row, index) => {
                const competitorName = row.querySelector('h5').textContent;
                const sales = document.getElementById(`sales-${index}`)?.value || '';
                const stock = document.getElementById(`stock-${index}`)?.value || '';
                
                formData.competitors.push({
                    name: competitorName,
                    sales: sales,
                    stock: stock
                });
            });
            
            console.log('Submitting form data:', formData);
            
            // Create a unique callback function name
            const callbackName = 'form_callback_' + Math.round(100000 * Math.random());
            
            // Set up the callback
            window[callbackName] = function(result) {
                console.log('Form submission response:', result);
                
                // Clean up
                delete window[callbackName];
                
                // Restore button state
                submitButton.disabled = false;
                submitButton.innerHTML = originalButtonText;
                
                if (result && result.status === 'success') {
                    // Show success message
                    const successMessage = document.getElementById('successMessage');
                    successMessage.style.display = 'block';
                    
                    // Reset form
                    form.reset();
                    form.classList.remove('was-validated');
                    document.getElementById('competitorModels').innerHTML = '';
                    
                    // Hide success message after 5 seconds
                    setTimeout(() => {
                        successMessage.style.display = 'none';
                    }, 5000);
                } else {
                    const errorMsg = result && result.message || 'Error al enviar los datos';
                    console.error('Error in form submission:', errorMsg);
                    alert('Error: ' + errorMsg);
                }
            };
            
            // Create script element for JSONP
            const script = document.createElement('script');
            const url = `${SCRIPT_URL}?action=submitData&data=${encodeURIComponent(JSON.stringify(formData))}&callback=${callbackName}`;
            console.log('Sending request to:', url);
            script.src = url;
            
            // Set up error handling
            script.onerror = function() {
                console.error('Script load error');
                alert('Error al conectar con el servidor. Por favor, inténtalo de nuevo.');
                submitButton.disabled = false;
                submitButton.innerHTML = originalButtonText;
                delete window[callbackName];
            };
            
            // Set a timeout to clean up if the request takes too long
            const timeout = setTimeout(() => {
                if (window[callbackName]) {
                    console.error('Request timed out');
                    alert('La solicitud está tardando demasiado. Por favor, verifica tu conexión e inténtalo de nuevo.');
                    submitButton.disabled = false;
                    submitButton.innerHTML = originalButtonText;
                    delete window[callbackName];
                    if (document.body.contains(script)) {
                        document.body.removeChild(script);
                    }
                }
            }, 30000); // 30 second timeout
            
            // Override the callback to clear the timeout
            const originalCallback = window[callbackName];
            window[callbackName] = function() {
                clearTimeout(timeout);
                originalCallback.apply(this, arguments);
            };
            
            // Add script to the page to make the request
            document.body.appendChild(script);
        }
    </script>
</body>
</html>
